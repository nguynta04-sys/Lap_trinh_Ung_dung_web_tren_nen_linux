server {
    listen 80;
    server_name nguyentuananh.local;

    # Yêu cầu 4.2 & 5.1: Phục vụ file SPA (index.html)
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html; 
    }

    # (MỚI) Yêu cầu 4.2 Backend: Proxy cho API
    # Chuyển tiếp tất cả các lệnh gọi /api/... đến Node-RED
    location /api/ {
        # Trỏ đến container node-red cổng 1880
        # Dùng http://node-red:1880 (KHÔNG có dấu / ở cuối)
        proxy_pass http://node-red:1880; 
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Yêu cầu 5.2: Proxy cho Node-RED Editor
    location /nodered/ {
        proxy_pass http://node-red:1880/; 
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Yêu cầu 5.3: Proxy cho Grafana
    location /grafana/ {
        # Bỏ dấu / ở cuối để Nginx không xóa subpath
        proxy_pass http://grafana:3000; 
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}